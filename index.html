<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Paper.js Operator Bounding Box</title>
    <!-- Paper.js -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js"
      integrity="sha512-ovjLI1ZcZe6bw+ImQ21r+sv8q/Vwob2kq7tFidK6E1LWfi0T4uobbmpfEU1//a9h9o5Kkt+MnMWf6rWlg0EiMw=="
      crossorigin="anonymous"
    ></script>
    <style>
      #img-container {
        position: relative;
        display: inline-block;
      }

      #img {
        display: block;
        width: 100%;
        height: auto;
      }

      #img-canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        pointer-events: none;
      }

      .label {
        position: absolute;
        padding: 2px 4px;
        font-family: sans-serif;
        border-radius: 2px;
        z-index: 20;
      }
    </style>
  </head>
  <body>
    <div id="img-container">
      <img
        id="img"
        src="https://storage.googleapis.com/tqv-prd-ssb01-data/friends/dp4cam01_ssb01_prd/video0/table5_r_operator/annotated/2025/05/12/17/c4aac411406f_video0_1747069314.0_table5_r_operator_annotated.jpg?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=portal-storage%40prod1-svc-rbzn.iam.gserviceaccount.com%2F20250515%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20250515T161225Z&X-Goog-Expires=1200&X-Goog-SignedHeaders=host&X-Goog-Signature=512e8914db1bc43e75d5d50c35953a3d7fc51bdbe4f3ce125f57dd98e0356ef88f523457602697d86017b9be439424294e4863520221104c647f83d9d289f404ee6aa010436488ad1eb97b3e4ccda9025e3ce81ead89dda91883608892830687f6743a92103279b1c771638b2ebc663018808437ff615a88d8d086fe6bdd768befbad0095e17ed9383f2f38548afca49c37199534085ebde00e5406b44fe90bfe85f50e4dd482cdcda168f25b998d2817a1d8cc657803cc45fda587f69bae9f531093b3b0523cc5069d6494c852b2cf4ad3632872a212571328936779c9b6d03204c25bb61b2e26f16f5bfe289662d09627919772886a4cca410aa5e5d42fc23"
        onload="initBoundingBoxes()"
      />
      <canvas id="img-canvas"></canvas>
    </div>

    <script type="text/javascript">
      const annotations = {
        operator: {
          140041368577832: {
            atype_name: "subject",
            color_space: "rgb",
            coords: [109, 64, 55, 77],
            label: "operator",
            origins: [
              "gs://tqv-prd-ssb01-rawdata/image_readings/dp4cam01_ssb01_prd/video0/atlftpd/2025/05/12/17/c4aac411406f_video0_1747069314.000000_atlftpd_scheduled.jpg",
            ],
            point: "(136.0,114.0)",
            result: null,
            rtype: "operator",
            threshold: 0.9585131406784058,
          },
          140043555318344: {
            atype_name: "anonymous_subject",
            color_space: "rgb",
            coords: [109, 64, 55, 77],
            label: "operator",
            origins: [
              "gs://tqv-prd-ssb01-rawdata/image_readings/dp4cam01_ssb01_prd/video0/atlftpd/2025/05/12/17/c4aac411406f_video0_1747069314.000000_atlftpd_scheduled.jpg",
            ],
            point: "(136.0,114.0)",
            result: null,
            rtype: "operator",
            threshold: 0.9585131406784058,
          },
        },
        person: {
          140041368577352: {
            atype_name: "subject",
            color_space: "rgb",
            coords: [486, 599, 125, 94],
            label: "person",
            origins: [
              "gs://tqv-prd-ssb01-rawdata/image_readings/dp4cam01_ssb01_prd/video0/atlftpd/2025/05/12/17/c4aac411406f_video0_1747069314.000000_atlftpd_scheduled.jpg",
            ],
            point: "(548.0,646.0)",
            result: null,
            rtype: "person",
            threshold: 0.9829328060150146,
          },
          140041371239432: {
            atype_name: "subject",
            color_space: "rgb",
            coords: [319, 199, 107, 88],
            label: "person",
            origins: [
              "gs://tqv-prd-ssb01-rawdata/image_readings/dp4cam01_ssb01_prd/video0/atlftpd/2025/05/12/17/c4aac411406f_video0_1747069314.000000_atlftpd_scheduled.jpg",
            ],
            point: "(372.0,243.0)",
            result: null,
            rtype: "person",
            threshold: 0.9992940425872803,
          },
          140041375495176: {
            atype_name: "anonymous_subject",
            color_space: "rgb",
            coords: [486, 599, 125, 94],
            label: "person",
            origins: [
              "gs://tqv-prd-ssb01-rawdata/image_readings/dp4cam01_ssb01_prd/video0/atlftpd/2025/05/12/17/c4aac411406f_video0_1747069314.000000_atlftpd_scheduled.jpg",
            ],
            point: "(548.0,646.0)",
            result: null,
            rtype: "person",
            threshold: 0.9829328060150146,
          },
          140041398061960: {
            atype_name: "anonymous_subject",
            color_space: "rgb",
            coords: [319, 199, 107, 88],
            label: "person",
            origins: [
              "gs://tqv-prd-ssb01-rawdata/image_readings/dp4cam01_ssb01_prd/video0/atlftpd/2025/05/12/17/c4aac411406f_video0_1747069314.000000_atlftpd_scheduled.jpg",
            ],
            point: "(372.0,243.0)",
            result: null,
            rtype: "person",
            threshold: 0.9992940425872803,
          },
        },
        region: {
          140041399920904: {
            atype_name: "region",
            color_space: "rgb",
            coords: [90, 60, 160, 260],
            label: "Workstation",
            origins: [
              "gs://tqv-prd-ssb01-rawdata/image_readings/dp4cam01_ssb01_prd/video0/atlftpd/2025/05/12/17/c4aac411406f_video0_1747069314.000000_atlftpd_scheduled.jpg",
            ],
            point: "(170.0,229.0)",
            result: null,
            rtype: "region",
            threshold: 0.5,
          },
        },
      };

      const bboxes = convertAnnotationsToBboxes(annotations);
      console.log("bboxes>", bboxes);

      function convertAnnotationsToBboxes(annotations) {
        const bboxes = {};

        for (const category in annotations) {
          for (const id in annotations[category]) {
            const item = annotations[category][id];
            const label = item.label || item.rtype; // fallback

            const coords = [...item.coords];
            if (
              item.threshold !== undefined &&
              typeof item.threshold === "number"
            ) {
              coords.push(item.threshold);
            }

            // Використовуємо label як ключ
            if (!bboxes[label]) {
              bboxes[label] = [];
            }

            bboxes[label].push(coords);
          }
        }

        return bboxes;
      }

      // Функція для малювання фреймів
      function drawBoundingBox([x, y, width, height], color, labelText) {
        new paper.Path.Rectangle({
          rectangle: new paper.Rectangle(x, y, width, height),
          strokeColor: color,
          strokeWidth: 2,
        });
        console.log(img.width, img.height);

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = labelText;
        label.style.left = `${x - 1}px`;
        label.style.top = `${y - 16}px`;
        label.style.fontSize = `${10}px`;
        label.style.backgroundColor = color;
        document.getElementById("img-container").appendChild(label);
      }

      // Ініціалізація фреймів на завантаженій картинці
      function initBoundingBoxes() {
        const img = document.getElementById("img");
        const canvas = document.getElementById("img-canvas");

        // Видалити всі старі лейбли перед оновленням
        const existingLabels = document.querySelectorAll(".label");
        existingLabels.forEach((label) => label.remove());

        // Синхронізуємо розміри canvas з розмірами картинки
        canvas.width = img.width;
        canvas.height = img.height;

        paper.setup(canvas);

        // Масштабування координат
        const scaleX = img.width / img.naturalWidth;
        const scaleY = img.height / img.naturalHeight;

        // Масштабуємо фрейми
        const categories = [
          { label: "operator", color: "deepskyblue" },
          { label: "person", color: "lightgreen" },
          { label: "Workstation", color: "tomato" },
        ];

        categories.forEach(({ label, color }) => {
          (bboxes[label] || []).forEach((box) => {
            const [x, y, width, height] = box.slice(0, 4);
            drawBoundingBox(
              [x * scaleX, y * scaleY, width * scaleX, height * scaleY],
              color,
              label
            );
          });
        });

        paper.view.draw();
      }

      // Оновлення фреймів при зміні розміру картинки
      window.addEventListener("resize", () => {
        initBoundingBoxes();
      });
    </script>
  </body>
</html>
