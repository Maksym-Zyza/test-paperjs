<script type="text/x-template" id="annotated-images-component-template">
  <div id="img-container">
      <img :src="mediaLink" id="img"/>
      <canvas v-if="showAnnotations" id="img-canvas"></canvas>
  </div>
</script>

<script>
  var visionMediaPopupComponent = {
    template: "#annotated-images-component-template",
    props: ["mediaLink", "showAnnotations"],
    data() {
      return {
        // ===>
        bboxes: [],
      };
    },
    methods: {
      // ===> Функція для конвертації анотацій
      convertAnnotationsToBboxes(annotations) {
        const bboxes = {};

        for (const category in annotations) {
          for (const id in annotations[category]) {
            const item = annotations[category][id];
            const label = item.label || item.rtype; // fallback

            const coords = [...item.coords];
            if (
              item.threshold !== undefined &&
              typeof item.threshold === "number"
            ) {
              coords.push(item.threshold);
            }

            // Використовуємо label як ключ
            if (!bboxes[label]) {
              bboxes[label] = [];
            }

            bboxes[label].push(coords);
          }
        }

        return bboxes;
      },

      // Функція для малювання фреймів
      drawBoundingBox([x, y, width, height], color, labelText) {
        new paper.Path.Rectangle({
          rectangle: new paper.Rectangle(x, y, width, height),
          strokeColor: color,
          strokeWidth: 2,
        });
        console.log(img.width, img.height);

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = labelText;
        label.style.left = `${x - 1}px`;
        label.style.top = `${y - 16}px`;
        label.style.fontSize = `${10}px`;
        label.style.backgroundColor = color;
        document.getElementById("img-container").appendChild(label);
      },

      // Ініціалізація фреймів на завантаженій картинці
      initBoundingBoxes() {
        const img = document.getElementById("img");
        const canvas = document.getElementById("img-canvas");

        // Видалити всі старі лейбли перед оновленням
        const existingLabels = document.querySelectorAll(".label");
        existingLabels.forEach((label) => label.remove());

        // Синхронізуємо розміри canvas з розмірами картинки
        canvas.width = img.width;
        canvas.height = img.height;

        paper.setup(canvas);

        // Масштабування координат
        const scaleX = img.width / img.naturalWidth;
        const scaleY = img.height / img.naturalHeight;

        // Масштабуємо фрейми
        const categories = [
          { label: "operator", color: "deepskyblue" },
          { label: "person", color: "lightgreen" },
          { label: "Workstation", color: "tomato" },
        ];

        categories.forEach(({ label, color }) => {
          (this.bboxes[label] || []).forEach((box) => {
            const [x, y, width, height] = box.slice(0, 4);
            this.drawBoundingBox(
              [x * scaleX, y * scaleY, width * scaleX, height * scaleY],
              color,
              label
            );
          });
        });

        paper.view.draw();
      },
      // ===>

      showAnnotations: async function () {
        this.bboxes = this.convertAnnotationsToBboxes(
          image_step.step_output.annotations
        );

        this.$nextTick(() => {
          const img = document.getElementById("img");
          if (img && this.showAnnotations) {
            img.addEventListener("load", () => {
              this.initBoundingBoxes();
            });

            // Якщо зображення вже кешоване і не викликає 'load'
            if (img.complete) {
              this.initBoundingBoxes();
            }
          }
        });

        console.log("this.bboxes>", this.bboxes);
        // Оновлення фреймів при зміні розміру картинки
        window.addEventListener("resize", () => {
          this.initBoundingBoxes();
        });

        $("#showAnnotations").show();
      },
    },
  };
</script>

<style>
  #img-container {
    position: relative;
    display: inline-block;
  }

  #img {
    display: block;
    width: 100%;
    height: auto;
  }

  #img-canvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 10;
    pointer-events: none;
  }

  .label {
    position: absolute;
    padding: 0 4px;
    font-family: sans-serif;
    border-radius: 2px;
    z-index: 20;
  }
</style>
